/*! albums - v1.0 - 2013-10-08 1:45:27 PM
* Copyright (c) 2013 hanwen.sah; Licensed  */
KISSY.add("gallery/albums/1.0/album-tpl",function(){return{html:'<div class="handers">\n  {{#if len !== 1}}\n  <span class="prev album-prev hander">&lt;</span>   \n  <span class="next album-next hander">&gt;</span>   \n  {{/if}}\n</div>\n<div class="box">   \n\n  <div class="album-action-bar">\n    <a class="album-big action" data-action="zoom" href="#nowhere"></a>\n    <a class="album-small action" data-action="zoom" href="#nowhere"></a>\n    <a class="rotation-pro action" data-action="rotation-pro" href="#nowhere"></a>\n    <a class="rotation-con action" data-action="rotation-con" href="#nowhere"></a>\n  </div>\n\n  <div class="album-preview-box">\n    <img class="J_preivew_img" src="{{src}}" alt="" />\n    <div class="album-thumb"></div>\n  </div>\n\n  <div class="box-main album-loading" style="height: {{h - 20}}px; {{#if w}}width: {{w}}px; {{/if}}">  \n    {{#if download}}\n      <a href="{{download}}"><img class="{{imgCls}}" src="{{src}}" alt="" /></a>\n    {{else}}\n      <img class="{{imgCls}}" src="{{src}}" style="display: none" alt="" />\n    {{/if}}\n  </div>   \n  <div class="box-aside" style="height: {{h}}px">   \n    <div class="aside-wrap">  \n      <div class="headline"><em class="J_num num">{{index + 1}}/{{len}}</em>{{title}} [<a class="action" data-action="fullscreen" href="#nowhere">\u5168\u5c4f</a>]\n      </div>  \n      {{#if desc}}\n      <p class="J_desc desc">{{prefix}}: {{{desc}}}</p>  \n      {{/if}}\n    </div>   \n  </div>   \n</div>\n'}}),KISSY.add("gallery/albums/1.0/dialog",function(a,b,c){function d(a){h=new c.DraggableDelegate({container:a,selector:".J_img",move:!1})}function e(a){return function(b){var c=g.get("album-id");g.fire(a+":"+c,{el:b.currentTarget})}}var f,g=new a.Dialog({width:"100%",height:"100%",elCls:"albums-dialog"});g.on("show",function(){a.Event.on(document,"mousewheel",function(a){var b=g.get("album-id");g.fire("wheel:"+b,{wheel:[a.deltaX||0,a.deltaY||0]}),a.halt()}),a.all("html").css("overflow-y","hidden"),g.stopDD()});var h;g.on("hide",function(){a.Event.detach(document,"mousewheel"),a.all("html").css("overflow-y","auto"),e("close")({})});var i={};return g.getWinHeight=function(){return i.height||(i.height=a.DOM.viewportHeight()),a.DOM.viewportHeight()},g.getWinWidth=function(){return i.width||(i.width=a.DOM.viewportWidth()),i.width},g.startDD=function(){return h.set("move",!0),h},g.stopDD=function(){h.set("move",!1)},g.on("change:step",g.stopDD),g.on("afterRenderUI",function(){f=g.get("contentEl"),f.delegate("click",".hander",e("hander")),f.delegate("click",".J_img",e("turn")),f.delegate("click",".action",e("action"));var b;a.Event.on(window,"resize",function(){g.get("visible")&&(b&&b.cancel(),b=a.later(function(){i={};var a=g.get("album-id");g.fire("resize:"+a)},100))}),a.Event.on(document,"keyup",function(a){if(g.get("visible")){var b=g.get("album-id");39===a.keyCode?g.fire("next:"+b):37===a.keyCode&&g.fire("prev:"+b)}}),d(f)}),g},{requires:["overlay","dd"]}),KISSY.add("gallery/albums/1.0/rotate",function(a){function b(b,e){var f={};return void 0===e&&(e=1),f=a.UA.ie&&a.UA.ie<9?c(b,e):d(b,e)}function c(b,c){b=b/180*Math.PI;var d=Math.cos(b)*c,e=Math.sin(b)*c,f=-Math.sin(b)*c,g="progid:DXImageTransform.Microsoft.Matrix(M11={costheta},M12={sinthetaN},M21={sintheta},M22={costheta},SizingMethod='auto expand')";return g=a.substitute(g,{costheta:d,sintheta:e,sinthetaN:f}),{filter:g}}function d(b,c){var d={"-moz-transform":"rotate({degree}deg) scale({scale})","-webkit-transform":"rotate({degree}deg) scale({scale})","-ms-transform":"rotate({degree}deg) scale({scale})","-o-transform":"rotate({degree}deg) scale({scale})",transform:"rotate({degree}deg) scale({scale})"};return a.each(d,function(e,f){d[f]=a.substitute(e,{degree:b,scale:c})}),d}return b}),KISSY.add("gallery/albums/1.0/plugin/thumb",function(a,b,c){function d(a){d.superclass.constructor.call(this,a)}var e=150,f=150;return a.extend(d,c,{pluginId:"thumb",pluginInitializer:function(a){this.host=a,this.dialog=a.dialog,this.contentEl=a.dialog.get("contentEl"),this._boundary=[null,null],this._bind()},_bind:function(){var a=this.host;a.on("afterScaleChange",function(){if(this._shouldShowView()){this._position();var a=this.dialog.startDD();a.on("dragalign",this._proxy,this),this.drag=a,this._hide()}else this.dialog.stopDD(),this._hide(!0)},this);var b=a.get("id");this.dialog.on("wheel:"+b,function(a){this._wheel(a.wheel)},this)},_shouldShowView:function(){return this.host.isOutBoundary()},_wheel:function(a){if(this._shouldShowView()){var b={left:0,top:0},c=this._boundary;"top"==c[1]||"bottom"==c[1]?b.left=-15*a[1]:b.top=-15*a[1];var d=this._getPosition();b={left:d.left+b.left,top:d.top+b.top},this._proxy(b),this.contentEl.all(".J_img").offset(this.position)}},_getPosition:function(){if(this.position)return this.position;var a=this.host,b=a.get("box"),c=a.get("padding"),d=a.get("scale"),e=c[3]+(b.view[0]-b.img[0]*d)/2,f=c[0]+(b.view[1]-b.img[1]*d)/2;return{left:e,top:f}},_proxy:function(a){if(this._shouldShowView()){var b=this.get("zoom"),c={left:a.left,top:a.top},d=this.boundary,g={},h=this.host.get("padding"),i=!1;if(c.left<d.viewRight?(c.left=d.viewRight,i=!0,this._boundaryStack("right")):c.left>=d.viewLeft&&(c.left=d.viewLeft,i=!0,this._boundaryStack("left")),c.top<d.viewBottom?(c.top=d.viewBottom,i=!0,this._boundaryStack("bottom")):c.top>d.viewTop&&(c.top=d.viewTop,i=!0,this._boundaryStack("top")),g.top=-f+(h[0]-c.top)*b+d.distance[1],g.left=-e+(h[3]-c.left)*b+d.distance[0],i){var j=a.drag||this.drag;j.setInternal("actualPos",c)}else this._boundaryStack("center");this.position=c,this.contentEl.all(".album-thumb").css(g),this._hide()}},_boundaryStack:function(a){a!=this._boundary[1]&&(this._boundary.shift(),this._boundary.push(a))},_hide:function(b){var c=this.contentEl,d=this.handle;b?c.all(".album-preview-box").css("visibility","hidden"):(c.all(".album-preview-box").css("visibility","visible"),d&&d.cancel(),d=a.later(function(){c.all(".album-preview-box").css("visibility","hidden")},1500),this.handle=d)},_position:function(a){var b,c,d,g,h=f,i=e,j=this.host,a=j.get("box"),k=this.dialog.get("contentEl"),l=j.get("scale"),m=j.get("padding"),n=a.img[0]*l,o=a.img[1]*l,p={top:0,left:0},q={distance:[0,0]};o/h>n/i?(c=h,d=c/o,b=d*n,q.distance[0]=(e-b)/2,p.left=(i-b)/2,p.height=h):(b=i,d=b/n,c=d*o,q.distance[1]=(f-c)/2,p.top=(h-c)/2,p.width=i),g={width:d*a.view[0],height:d*a.view[1]},q.viewLeft=m[3],q.viewRight=q.viewLeft-(n-a.view[0]),q.viewTop=m[0],q.viewBottom=q.viewTop-(o-a.view[1]),g.height>c?(q.viewTop=(a.view[1]-o)/2+m[0],q.viewBottom=q.viewTop,q.distance[1]+=(g.height-c)/2,g.height=c):g.width>b&&(q.viewLeft=(a.view[0]-n)/2+m[3],q.viewRight=q.viewLeft,q.distance[0]+=(g.width-b)/2,g.width=b),g.left=-e-(a.view[0]-n)/2*d+q.distance[0],g.top=-f-(a.view[1]-o)/2*d+q.distance[1],this.boundary=q,k.all(".J_preivew_img").css(p),k.all(".album-thumb").css(g),this.set("zoom",d),this.position=null},_getPreviewBox:function(){this.host;var a=this.get("box");a.img[0],a.img[1],a.view[0],a.view[1]},pluginDestructor:function(){}},{zoom:{value:null},preview:{},position:{}}),d},{requires:["node","base"]}),KISSY.add("gallery/albums/1.0/index",function(a,b,c,d,e,f,g,h,i,j){function k(a){a||document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function l(a){var b=this;l.superclass.constructor.call(b,a),b.init()}function m(a){if(a.prop("naturalWidth"))return{width:a.prop("naturalWidth"),height:a.prop("naturalHeight")};var b=new Image;return b.src=a.attr("src"),{width:b.width,height:b.height}}var n=b.all,o=new g(f.html);return a.extend(l,c,{init:function(){var a=this.get("baseEl");a.length&&(this.set("id",1),h.render(),this._bindEvent(),this.dialog=h,this.plug(new j))},_setEls:function(){var a=this.get("baseEl"),b=n(this.get("img"),a);return b.each(function(a,b){a.attr("data-index",b)}),this.set("imgList",b),this.set("len",b.length),b},_bindEvent:function(){var b=this.get("baseEl"),c=this.get("trigger"),d=this.get("img");a.Event.delegate(b,c,d,this._show,this);var e=this.get("id");h.on("hander:"+e,this._go,this),h.on("action:"+e,this._action,this),h.on("resize:"+e,this._resize,this),h.on("turn:"+e,this._turn,this),h.on("close:"+e,this._close,this);var f=this;h.on("prev:"+e,function(){f.go(-1)}),h.on("next:"+e,function(){f.go(1)}),this.on("switch",this._hander,this)},_action:function(a){var b=a.el,c=n(b).attr("data-action");"rotation-con"==c?this._rotation(-90):"rotation-pro"==c?this._rotation(90):"zoom"==c?this._zoom(n(b)):"fullscreen"==c&&this._fullscreen()},_fullscreen:function(){h.get("el").addClass("fullscreen");var a=this.get("padding");this._paddingBackup=a,this.set("padding",[10,10,10,10]),k(),this.go(0)},_close:function(){this._paddingBackup&&(this.set("padding",this._paddingBackup),delete this._paddingBackup,h.get("el").removeClass("fullscreen"),k(!0))},_rotation:function(a){var b=h.get("contentEl").all(".J_img"),c=this.get("rotation"),d=this.get("scale");c+=parseInt(a,10),this.set("rotation",c);var e=i(c,d);b.css(e)},_resize:function(){var b=h.get("contentEl").all(".J_img"),c=this.get("padding"),d=h.getWinHeight()-c[0]-c[2];if(6===a.UA.ie){var e=h.getWinWidth()-c[1]-c[3];h.get("contentEl").all(".box-main").css({width:e,height:d-20})}else h.get("contentEl").all(".box-main").height(d-20);h.get("contentEl").all(".box-aside").height(d),this._position(b,1)},_hander:function(a){var b=h.get("contentEl"),c=b.all(".hander");0===a.from&&c.removeClass("step-start"),0===a.to&&c.addClass("step-start");var d=this.get("len")-1;a.to===d&&c.addClass("step-last"),a.from===d&&c.removeClass("step-last")},_zoom:function(a){var b=h.get("contentEl").all(".J_img"),c=a.hasClass("album-big");c?this._zoomOut(b,.2):this._zoomOut(b,-.2)},_zoomOut:function(b,c){var d=this.get("rotation"),e=this.get("scale"),f=this.get("box").img,g=this.get("zoom");e+=c,1>e&&c>0&&(e=1),1>e&&0>c&&(e=this.get("zoom")),g=(e-g)/2;var h=i(d,e);if(a.UA.ie<9){var j=this.get("position");h.left=j[0]-f[0]*g,h.top=j[1]-f[1]*g}b.css(h),this.set("scale",e),e===this.get("zoom")&&this._position(b,!0)},_position:function(b,c){if(b.data("loaded")){var d=m(b),e=this.get("padding"),f=h.getWinHeight()-e[0]-e[2],g=h.getWinWidth()-e[1]-e[3],j=d.height,k=d.width,l=0,n=0,o=c?"inline":"none",p={top:l,left:n,position:"relative",display:o},q=1,r=a.UA.ie;j>f||k>g?j/f>k/g?(q=f/j,r&&9>r?p.left=(g-k*q)/2:(p.top=-(j-f)/2,p.left=(g-k)/2)):(q=g/k,r&&9>r?p.top=(f-j*q)/2:(p.top=(f-j)/2,p.left=-(k-g)/2)):(p.left=(g-k)/2,p.top=(f-j)/2),c&&1!==c||(p=a.mix(i(0,q),p)),b.css(p),h.get("contentEl").all(".album-loading").removeClass("album-loading"),c||b.fadeIn(),this.set("zoom",q),this.set("box",{view:[g,f],img:[k,j]}),this.set("position",[p.left,p.top]),this.set("scale",q)}},show:function(a,b){var c=this.get("baseEl");this._show({target:c.all(a)[0]},b)},_show:function(b,c){this.set("rotation",0);var d=b.target,e=n(d).attr("data-original-url"),f=n(d).attr("data-download");e||(e=d.src),this._setEls();var g=n(d).attr("data-index");this.set("index",parseInt(g,10));var i=this.get("len"),j=h.getWinHeight()+20,k=h.getWinWidth(),l=this.get("padding"),m={src:e,imgCls:"J_img",index:+g,len:i,h:j-l[0]-l[2],w:6===a.UA.ie?k-l[1]-l[3]:null,desc:n(d).attr("data-desc")||"",download:f,title:this.get("title")},o=this.get("template").render(a.mix(m,this.get("datas")));h.set("bodyContent",o),h.show(),h.set("album-id",this.get("id"));var p=h.get("contentEl").all(".J_img"),q=this;p.data("loaded",!1),p.on("load",function(){p.data("loaded",!0),q._position(p),c&&c()})},next:function(){},go:function(a){a=parseInt(a,10);var b=this.get("imgList").length,c=this.get("index")+a;if(-1===c&&(c=b-1),c===b&&(c=0),!(0>c||c>b-1)){this.get("baseEl");var d=this.get("imgList").item(c);this.fire("switch",{from:this.get("index"),to:c}),this.show(d,function(){h.fire("change:step")})}},_go:function(a){var b=n(a.el),c=b.hasClass("prev")?-1:1;this.go(c)},isOutBoundary:function(){var a=this.get("box"),b=this.get("scale");return a.img[0]*b>a.view[0]||a.img[1]*b>a.view[1]},_turn:function(){this.isOutBoundary()||this.go(1)}},{ATTRS:{baseEl:{setter:function(a){return n(a)}},imgList:{value:null},img:{value:".J_ImgDD"},len:{value:0},trigger:{value:"click"},title:{value:"\u67e5\u770b\u56fe\u7247"},index:{value:0},box:{value:{}},datas:{value:{prefix:"\u56fe\u7247\u8bf4\u660e"}},template:{value:o},padding:{value:[47,287,47,47]},id:{setter:function(){return a.guid()}},rotation:{value:0},scale:{value:1},theme:{value:"gallery/albums/theme"}}}),l},{requires:["node","rich-base","overlay","anim","./album-tpl","xtemplate","./dialog","./rotate","./plugin/thumb","./index.css"]});